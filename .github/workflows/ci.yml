name: CI

on: 
  [push, pull_request]

jobs:
  build:
    runs-on: self-hosted
    
    steps:
      # Nettoyage préalable des fichiers Python
      - name: Nettoyage préalable
        run: |
          echo "🧹 Nettoyage des fichiers cache Python..."
          sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          sudo find . -name "*.pyc" -delete 2>/dev/null || true
          echo "Nettoyage terminé!"
      
      # Checkout du dépôt
      - name: Checkout dépot
        uses: actions/checkout@v3
        with:
          clean: true

      # Créer fichier .env pour les tests
      - name: Créer fichier .env pour les tests
        run: |
          echo "DB_HOST=localhost" > .env
          echo "DB_PORT=3306" >> .env
          echo "DB_NAME=labo03_db" >> .env
          echo "DB_USER=labo03" >> .env
          echo "DB_PASS=labo03" >> .env
          echo "REDIS_HOST=localhost" >> .env
          echo "REDIS_PORT=6380" >> .env
          echo "REDIS_DB=0" >> .env

      # Créer le réseau Docker si nécessaire
      - name: Créer le réseau Docker
        run: |
          echo "🌐 Vérification du réseau Docker..."
          docker network create labo03-network 2>/dev/null || echo "Réseau labo03-network existe déjà"
          docker network ls | grep labo03-network

      # Nettoyer les conteneurs existants
      - name: Nettoyer les conteneurs existants
        run: |
          echo "🧹 Nettoyage des conteneurs existants..."
          docker compose down 2>/dev/null || docker-compose down 2>/dev/null || true
          docker container prune -f 2>/dev/null || true
          echo "Nettoyage terminé"

      # Démarrer les services avec Docker Compose
      - name: Démarrer les services avec Docker Compose
        run: |
          echo "🚀 Démarrage des services de base de données..."
          docker compose up -d mysql redis || docker-compose up -d mysql redis
          echo "⏳ Attente que les services soient prêts..."
          sleep 20

      # Installer les dépendances Python
      - name: Installer les dépendances Python
        run: |
          python3 -m pip install --upgrade pip --break-system-packages
          pip3 install -r requirements.txt --break-system-packages
          pip3 install pytest --break-system-packages

      # Lancer les tests
      - name: Lancer les tests
        run: |
          export PYTHONPATH=$(pwd)/src
          /home/log430/.local/bin/pytest src/tests --maxfail=1 --disable-warnings -v

      # Déploiement local si les tests réussissent
      - name: Déploiement local
        if: success()
        run: |
          echo "🚀 Déploiement de l'application..."
          docker compose down || docker-compose down || true
          docker compose up -d --build || docker-compose up -d --build
          echo "📊 Statut des conteneurs:"
          docker compose ps || docker-compose ps
          echo "✅ Déploiement terminé!"

      # Nettoyage final des fichiers Python
      - name: Nettoyage final
        if: always()
        run: |
          echo "🧹 Nettoyage des fichiers cache Python..."
          sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          sudo find . -name "*.pyc" -delete 2>/dev/null || true
          echo "✅ Nettoyage final terminé!"
