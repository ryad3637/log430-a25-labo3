name: CI

on: 
  [push, pull_request]

jobs:
  build:
    runs-on: self-hosted
    
    steps:
      # Nettoyage prÃ©alable des fichiers Python
      - name: Nettoyage prÃ©alable
        run: |
          echo "ğŸ§¹ Nettoyage des fichiers cache Python..."
          sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          sudo find . -name "*.pyc" -delete 2>/dev/null || true
          echo "Nettoyage terminÃ©!"
      
      # Checkout du dÃ©pÃ´t
      - name: Checkout dÃ©pot
        uses: actions/checkout@v3
        with:
          clean: true

      # CrÃ©er fichier .env pour les tests
      - name: CrÃ©er fichier .env pour les tests
        run: |
          echo "DB_HOST=localhost" > .env
          echo "DB_PORT=3306" >> .env
          echo "DB_NAME=labo03_db" >> .env
          echo "DB_USER=labo03" >> .env
          echo "DB_PASS=labo03" >> .env
          echo "REDIS_HOST=localhost" >> .env
          echo "REDIS_PORT=6380" >> .env
          echo "REDIS_DB=0" >> .env

      # CrÃ©er le rÃ©seau Docker si nÃ©cessaire
      - name: CrÃ©er le rÃ©seau Docker
        run: |
          echo "ğŸŒ VÃ©rification du rÃ©seau Docker..."
          docker network create labo03-network 2>/dev/null || echo "RÃ©seau labo03-network existe dÃ©jÃ "
          docker network ls | grep labo03-network

      # Nettoyer les conteneurs existants
      - name: Nettoyer les conteneurs existants
        run: |
          echo "ğŸ§¹ Nettoyage des conteneurs existants..."
          docker compose down 2>/dev/null || docker-compose down 2>/dev/null || true
          docker container prune -f 2>/dev/null || true
          echo "Nettoyage terminÃ©"

      # DÃ©marrer les services avec Docker Compose
      - name: DÃ©marrer les services avec Docker Compose
        run: |
          echo "ğŸš€ DÃ©marrage des services de base de donnÃ©es..."
          docker compose up -d mysql redis || docker-compose up -d mysql redis
          echo "â³ Attente que les services soient prÃªts..."
          sleep 20

      # Installer les dÃ©pendances Python
      - name: Installer les dÃ©pendances Python
        run: |
          python3 -m pip install --upgrade pip --break-system-packages
          pip3 install -r requirements.txt --break-system-packages
          pip3 install pytest --break-system-packages

      # Lancer les tests
      - name: Lancer les tests
        run: |
          export PYTHONPATH=$(pwd)/src
          /home/log430/.local/bin/pytest src/tests --maxfail=1 --disable-warnings -v

      # DÃ©ploiement local si les tests rÃ©ussissent
      - name: DÃ©ploiement local
        if: success()
        run: |
          echo "ğŸš€ DÃ©ploiement de l'application..."
          docker compose down || docker-compose down || true
          docker compose up -d --build || docker-compose up -d --build
          echo "ğŸ“Š Statut des conteneurs:"
          docker compose ps || docker-compose ps
          echo "âœ… DÃ©ploiement terminÃ©!"

      # Nettoyage final des fichiers Python
      - name: Nettoyage final
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage des fichiers cache Python..."
          sudo find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          sudo find . -name "*.pyc" -delete 2>/dev/null || true
          echo "âœ… Nettoyage final terminÃ©!"
